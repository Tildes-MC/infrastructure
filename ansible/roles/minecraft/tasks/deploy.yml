---
- name: Ensure minecraft directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0755"
  loop:
    - "{{ minecraft_app_dir }}"
    - "{{ minecraft_log_dir }}"

- name: Synchronize minecraft app
  ansible.posix.synchronize:
    src: "{{ repo_root }}/apps/minecraft/"
    dest: "{{ minecraft_app_dir }}/"
    delete: true
    rsync_opts:
      - "--filter=':- .gitignore'"
      - "--exclude=*.j2"
      - "--chmod=D0755,F0644"

- name: Find all .j2 templates
  ansible.builtin.find:
    paths: "{{ repo_root }}/apps/minecraft"
    patterns: "*.j2"
    recurse: true
  delegate_to: localhost
  become: false
  register: j2_templates

- name: Template .j2 files
  ansible.builtin.template:
    src: "{{ item.path }}"
    dest: "{{ minecraft_app_dir }}/{{ item.path | relpath(repo_root + '/apps/minecraft') | regex_replace('\\.j2$', '') }}"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "{{ '0755' if item.path.endswith('.sh.j2') else '0640' }}"
  loop: "{{ j2_templates.files }}"
  loop_control:
    label: "{{ item.path | relpath(repo_root + '/apps/minecraft') }}"

- name: Find script files
  ansible.builtin.find:
    paths: "{{ minecraft_app_dir }}/scripts"
    patterns:
      - "*.sh"
      - "*.py"
  register: script_files

- name: Make scripts executable
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "0755"
  loop: "{{ script_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Fix minecraft app ownership
  ansible.builtin.file:
    path: "{{ minecraft_app_dir }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    recurse: true

- name: Deploy minecraft crontab
  ansible.builtin.template:
    src: minecraft-cron.j2
    dest: "/var/spool/cron/crontabs/{{ minecraft_user }}"
    owner: root
    group: crontab
    mode: "0600"
